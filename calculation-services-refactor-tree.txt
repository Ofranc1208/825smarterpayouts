================================================================================
ğŸ§® CALCULATION SERVICE REFACTOR ANALYSIS
================================================================================
Created: 2024
Purpose: Map the current monolithic calculationService.ts structure to plan
         a clean refactoring into smaller, focused modules

================================================================================
ğŸ“Š CURRENT STATE ANALYSIS
================================================================================

FILE: src/services/calculationService.ts (589 lines)
STATUS: âš ï¸ MONOLITHIC - Too many responsibilities in one file

DEPENDENCIES:
â”œâ”€â”€ app/utils/npvCalculations.ts
â”‚   â”œâ”€â”€ calcNPVWithAdjustment()
â”‚   â”œâ”€â”€ calculateMinMaxNPV()
â”‚   â”œâ”€â”€ calculateGuaranteedNPV()
â”‚   â””â”€â”€ PaymentFrequency (type)
â”œâ”€â”€ app/utils/deathBenefit.ts
â”‚   â””â”€â”€ calculateDeathBenefitMaxPV()
â”œâ”€â”€ app/utils/npvConfig.ts
â”‚   â”œâ”€â”€ BASE_DISCOUNT_RATE
â”‚   â”œâ”€â”€ BASE_DISCOUNT_RATE_LCP
â”‚   â”œâ”€â”€ AMOUNT_ADJUSTMENTS
â”‚   â”œâ”€â”€ FAMILY_PROTECTION_DISCOUNT_RATE
â”‚   â”œâ”€â”€ RATE_SPREADS
â”‚   â””â”€â”€ adjustmentMap
â”œâ”€â”€ src/utils/lcpMappingService.ts
â”‚   â””â”€â”€ LCPMappingService.mapFormValuesToCalculationKeys()
â””â”€â”€ src/types.ts
    â”œâ”€â”€ LCPFormData
    â”œâ”€â”€ LCPCalculationResult
    â”œâ”€â”€ GuaranteedFormData
    â”œâ”€â”€ GuaranteedCalculationResult
    â””â”€â”€ CalculationError

================================================================================
ğŸ” CURRENT CLASS STRUCTURE
================================================================================

export class CalculationService {
  
  // ========================================
  // 1ï¸âƒ£ LIFE-CONTINGENT PAYMENT METHODS
  // ========================================
  
  âœ… calculateLCP(formData: LCPFormData): LCPCalculationResult
     Lines: 37-137 (101 lines)
     Purpose: Calculate Life-Contingent Payments with health adjustments
     Responsibilities:
       - Validate LCP form data
       - Extract payment, date, and health profile data
       - Calculate main NPV with LCP adjustments
       - Calculate min/max payout range
       - Calculate family protection (death benefit)
       - Return complete LCP result
     Dependencies:
       - calcNPVWithAdjustment()
       - calculateMinMaxNPV()
       - calculateDeathBenefitMaxPV()
       - LCPMappingService
       - adjustmentMap
     
  âœ… calculateLCPLumpSum(formData): LCPCalculationResult
     Lines: 222-357 (136 lines)
     Purpose: Calculate LCP for multiple lump sum payments
     Responsibilities:
       - Validate LCP lump sum data
       - Calculate LCP-adjusted discount rate
       - Process each lump sum payment individually
       - Sum all payments with LCP health adjustments
       - Calculate family protection (death benefit)
       - Apply min/max adjustments to total
       - Return complete LCP result
     Dependencies:
       - calculateDeathBenefitMaxPV()
       - adjustmentMap
       - BASE_DISCOUNT_RATE_LCP
       - RATE_SPREADS
       - AMOUNT_ADJUSTMENTS

  // ========================================
  // 2ï¸âƒ£ GUARANTEED PAYMENT METHODS
  // ========================================
  
  âœ… calculateLumpSum(formData): GuaranteedCalculationResult
     Lines: 143-215 (73 lines)
     Purpose: Calculate single lump sum payment (Guaranteed)
     Responsibilities:
       - Validate lump sum data
       - Calculate time to payment
       - Calculate NPV with discount factor
       - Calculate min/max payout range
       - Return guaranteed result
     Dependencies:
       - BASE_DISCOUNT_RATE
       - RATE_SPREADS
       - AMOUNT_ADJUSTMENTS
     
  âœ… calculateGuaranteed(formData: GuaranteedFormData): GuaranteedCalculationResult
     Lines: 363-421 (59 lines)
     Purpose: Calculate Guaranteed Payments (regular payments)
     Responsibilities:
       - Route to lump sum if needed
       - Validate guaranteed form data
       - Calculate min/max NPV
       - Return guaranteed result
     Dependencies:
       - calculateMinMaxNPV()
       - calculateGuaranteedLumpSum() (private)
       - BASE_DISCOUNT_RATE
       - AMOUNT_ADJUSTMENTS
     
  âœ… calculateGuaranteedLumpSum(formData): GuaranteedCalculationResult [PRIVATE]
     Lines: 427-526 (100 lines)
     Purpose: Calculate multiple lump sum payments (Guaranteed)
     Responsibilities:
       - Validate payments array
       - Process each lump sum payment
       - Sum all payments
       - Apply min/max adjustments to total
       - Track date range
       - Return guaranteed result
     Dependencies:
       - BASE_DISCOUNT_RATE
       - RATE_SPREADS
       - AMOUNT_ADJUSTMENTS

  // ========================================
  // 3ï¸âƒ£ UTILITY METHODS
  // ========================================
  
  âœ… calculateComparison(lcpFormData, guaranteedFormData)
     Lines: 532-546 (15 lines)
     Purpose: Calculate both LCP and Guaranteed for comparison
     Responsibilities:
       - Call calculateLCP()
       - Call calculateGuaranteed()
       - Return both results
     Dependencies:
       - calculateLCP()
       - calculateGuaranteed()
  
  // ========================================
  // 4ï¸âƒ£ VALIDATION METHODS
  // ========================================
  
  âœ… validateLCPFormData(formData: LCPFormData)
     Lines: 552-571 (20 lines)
     Purpose: Pre-calculation validation for LCP
     Responsibilities:
       - Check all required LCP fields
       - Return validation result with errors
     Dependencies: None
     
  âœ… validateGuaranteedFormData(formData: GuaranteedFormData)
     Lines: 576-588 (13 lines)
     Purpose: Pre-calculation validation for Guaranteed
     Responsibilities:
       - Check all required Guaranteed fields
       - Return validation result with errors
     Dependencies: None

}

================================================================================
ğŸ¯ IDENTIFIED PROBLEMS
================================================================================

1. âš ï¸ SINGLE RESPONSIBILITY VIOLATION
   - One class handles LCP, Guaranteed, Lump Sum, Validation, and Comparison
   - Hard to test individual calculation types
   - Hard to maintain and debug

2. âš ï¸ CODE DUPLICATION
   - Lump sum calculation logic duplicated between:
     * calculateLumpSum() (Guaranteed)
     * calculateLCPLumpSum() (LCP)
     * calculateGuaranteedLumpSum() (Guaranteed multiple)
   - Date calculation logic repeated multiple times
   - NPV calculation patterns repeated

3. âš ï¸ MIXED CONCERNS
   - Validation mixed with calculation logic
   - Data transformation mixed with business logic
   - Error handling scattered throughout

4. âš ï¸ LARGE METHODS
   - calculateLCPLumpSum: 136 lines
   - calculateLCP: 101 lines
   - calculateGuaranteedLumpSum: 100 lines
   - Hard to understand and maintain

5. âš ï¸ TIGHT COUPLING
   - Direct dependencies on multiple utility files
   - Hard to mock for testing
   - Changes in one area affect others

================================================================================
ğŸ“‹ PROPOSED REFACTORING STRUCTURE
================================================================================

NEW DIRECTORY STRUCTURE:
src/services/calculations/
â”œâ”€â”€ index.ts                          # Main export barrel
â”œâ”€â”€ types.ts                          # Shared calculation types
â”œâ”€â”€ constants.ts                      # Calculation constants
â”‚
â”œâ”€â”€ core/                             # Core calculation engines
â”‚   â”œâ”€â”€ npvCalculator.ts              # NPV calculation logic
â”‚   â”œâ”€â”€ discountRateCalculator.ts    # Discount rate calculations
â”‚   â”œâ”€â”€ dateCalculator.ts             # Date/time calculations
â”‚   â””â”€â”€ roundingUtils.ts              # Rounding and formatting
â”‚
â”œâ”€â”€ lcp/                              # Life-Contingent Payment calculations
â”‚   â”œâ”€â”€ LCPCalculationService.ts      # Main LCP service
â”‚   â”œâ”€â”€ LCPLumpSumCalculator.ts       # LCP lump sum logic
â”‚   â”œâ”€â”€ LCPHealthAdjustments.ts       # Health profile adjustments
â”‚   â””â”€â”€ LCPValidator.ts               # LCP validation
â”‚
â”œâ”€â”€ guaranteed/                       # Guaranteed Payment calculations
â”‚   â”œâ”€â”€ GuaranteedCalculationService.ts   # Main Guaranteed service
â”‚   â”œâ”€â”€ GuaranteedLumpSumCalculator.ts    # Guaranteed lump sum logic
â”‚   â””â”€â”€ GuaranteedValidator.ts            # Guaranteed validation
â”‚
â”œâ”€â”€ family-protection/                # Family Protection (Death Benefit)
â”‚   â”œâ”€â”€ FamilyProtectionCalculator.ts     # Death benefit calculations
â”‚   â””â”€â”€ FamilyProtectionService.ts        # Service wrapper
â”‚
â””â”€â”€ comparison/                       # Comparison utilities
    â””â”€â”€ ComparisonService.ts          # Compare LCP vs Guaranteed

================================================================================
ğŸ”„ REFACTORING PLAN - PHASE BY PHASE
================================================================================

PHASE 1: EXTRACT UTILITIES (Low Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Extract reusable utility functions
Files to create:
  âœ… src/services/calculations/core/dateCalculator.ts
     - extractMonthsFromToday()
     - calculateDateDifference()
     - addMonthsToDate()
  
  âœ… src/services/calculations/core/roundingUtils.ts
     - roundUp100()
     - roundUp10k()
     - formatCurrency()
  
  âœ… src/services/calculations/core/discountRateCalculator.ts
     - calculatePeriodicRate()
     - calculateDiscountFactor()
     - applyHealthAdjustments()

PHASE 2: EXTRACT VALIDATORS (Low Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Separate validation logic
Files to create:
  âœ… src/services/calculations/lcp/LCPValidator.ts
     - Move validateLCPFormData()
     - Add field-level validation
  
  âœ… src/services/calculations/guaranteed/GuaranteedValidator.ts
     - Move validateGuaranteedFormData()
     - Add field-level validation

PHASE 3: EXTRACT LCP CALCULATIONS (Medium Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Separate LCP logic into focused modules
Files to create:
  âœ… src/services/calculations/lcp/LCPCalculationService.ts
     - Move calculateLCP()
     - Use extracted utilities
  
  âœ… src/services/calculations/lcp/LCPLumpSumCalculator.ts
     - Move calculateLCPLumpSum()
     - Use extracted utilities
  
  âœ… src/services/calculations/lcp/LCPHealthAdjustments.ts
     - Health profile adjustment logic
     - LCP key mapping

PHASE 4: EXTRACT GUARANTEED CALCULATIONS (Medium Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Separate Guaranteed logic into focused modules
Files to create:
  âœ… src/services/calculations/guaranteed/GuaranteedCalculationService.ts
     - Move calculateGuaranteed()
     - Move calculateLumpSum()
  
  âœ… src/services/calculations/guaranteed/GuaranteedLumpSumCalculator.ts
     - Move calculateGuaranteedLumpSum()
     - Consolidate lump sum logic

PHASE 5: EXTRACT FAMILY PROTECTION (Low Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Centralize death benefit calculations
Files to create:
  âœ… src/services/calculations/family-protection/FamilyProtectionService.ts
     - Wrapper for calculateDeathBenefitMaxPV()
     - Add logging and error handling

PHASE 6: REFACTOR ORCHESTRATOR (Medium Risk)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Transform calculationService.ts into thin orchestration layer
Files to update:
  âœ… src/services/calculationService.ts
     - KEEP the same file and CalculationService class
     - KEEP all public method signatures (no breaking changes)
     - REPLACE implementation logic with calls to new modules
     - Transform from 589 lines to ~150 lines
     - Acts as orchestrator/coordinator for all calculations

PHASE 7: VERIFY NO BREAKING CHANGES (Critical)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Ensure all existing code works without modification
Verification steps:
  - Run all existing tests
  - Verify all imports still work
  - Check that all method signatures unchanged
  - Performance testing
  - Integration testing

PHASE 8: CLEANUP & DOCUMENTATION (Final)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goal: Finalize refactoring
  - Remove any unused imports from calculationService.ts
  - Add comments explaining orchestration pattern
  - Update documentation
  - Code review
  - Merge to main

================================================================================
ğŸ“¦ NEW MODULE RESPONSIBILITIES
================================================================================

1ï¸âƒ£ CORE UTILITIES
   Purpose: Reusable calculation primitives
   Files: dateCalculator.ts, roundingUtils.ts, discountRateCalculator.ts
   Dependencies: None (pure functions)
   Exports: Pure utility functions

2ï¸âƒ£ LCP CALCULATION SERVICE
   Purpose: Life-Contingent Payment calculations
   Files: LCPCalculationService.ts, LCPLumpSumCalculator.ts, LCPHealthAdjustments.ts
   Dependencies: Core utilities, npvCalculations, deathBenefit
   Exports: calculateLCP(), calculateLCPLumpSum()

3ï¸âƒ£ GUARANTEED CALCULATION SERVICE
   Purpose: Guaranteed Payment calculations
   Files: GuaranteedCalculationService.ts, GuaranteedLumpSumCalculator.ts
   Dependencies: Core utilities, npvCalculations
   Exports: calculateGuaranteed(), calculateGuaranteedLumpSum()

4ï¸âƒ£ FAMILY PROTECTION SERVICE
   Purpose: Death benefit calculations
   Files: FamilyProtectionService.ts
   Dependencies: deathBenefit.ts
   Exports: calculateFamilyProtection()

5ï¸âƒ£ VALIDATION SERVICES
   Purpose: Pre-calculation validation
   Files: LCPValidator.ts, GuaranteedValidator.ts
   Dependencies: None
   Exports: validate() methods

6ï¸âƒ£ COMPARISON SERVICE
   Purpose: Compare calculation types
   Files: ComparisonService.ts
   Dependencies: LCP Service, Guaranteed Service
   Exports: compareCalculations()

7ï¸âƒ£ ORCHESTRATOR (Main Entry Point)
   Purpose: Coordinate all calculations - KEEP EXISTING FILE
   Files: calculationService.ts (REFACTORED, NOT REPLACED)
   Dependencies: All services
   Exports: Same API as current CalculationService
   Note: This is the EXISTING file, just refactored to delegate to modules

================================================================================
âœ… BENEFITS OF REFACTORING
================================================================================

1. âœ… SINGLE RESPONSIBILITY
   - Each module has one clear purpose
   - Easier to understand and maintain

2. âœ… TESTABILITY
   - Small, focused modules easy to unit test
   - Can mock dependencies easily
   - Better test coverage

3. âœ… REUSABILITY
   - Core utilities can be used anywhere
   - Calculation logic separated from validation

4. âœ… MAINTAINABILITY
   - Changes isolated to specific modules
   - Easier to debug issues
   - Clear file structure

5. âœ… SCALABILITY
   - Easy to add new calculation types
   - Can extend without modifying existing code

6. âœ… DEBUGGING
   - Smaller files easier to navigate
   - Clear separation of concerns
   - Better error messages

================================================================================
âš ï¸ RISKS & MITIGATION
================================================================================

RISK 1: Breaking Changes
  Mitigation: Keep existing calculationService.ts as orchestrator with same API

RISK 2: Regression Bugs
  Mitigation: Comprehensive testing before/after refactoring

RISK 3: Import Hell
  Mitigation: Use barrel exports (index.ts)

RISK 4: Over-Engineering
  Mitigation: Start simple, refactor incrementally

================================================================================
ğŸ§ª TESTING STRATEGY
================================================================================

1. âœ… BEFORE REFACTORING
   - Create comprehensive test suite for current CalculationService
   - Document all expected inputs/outputs
   - Save test results as baseline

2. âœ… DURING REFACTORING
   - Test each new module independently
   - Verify facade maintains same behavior
   - Run regression tests after each phase

3. âœ… AFTER REFACTORING
   - Compare new results with baseline
   - Performance testing
   - Integration testing

================================================================================
ğŸ“ IMPLEMENTATION CHECKLIST
================================================================================

PREPARATION:
  â˜ Review this document with team
  â˜ Get approval for refactoring approach
  â˜ Create feature branch
  â˜ Set up test baseline

PHASE 1: Core Utilities
  â˜ Create dateCalculator.ts
  â˜ Create roundingUtils.ts
  â˜ Create discountRateCalculator.ts
  â˜ Test utilities independently

PHASE 2: Validators
  â˜ Create LCPValidator.ts
  â˜ Create GuaranteedValidator.ts
  â˜ Test validators

PHASE 3: LCP Services
  â˜ Create LCPCalculationService.ts
  â˜ Create LCPLumpSumCalculator.ts
  â˜ Create LCPHealthAdjustments.ts
  â˜ Test LCP services

PHASE 4: Guaranteed Services
  â˜ Create GuaranteedCalculationService.ts
  â˜ Create GuaranteedLumpSumCalculator.ts
  â˜ Test Guaranteed services

PHASE 5: Family Protection
  â˜ Create FamilyProtectionService.ts
  â˜ Test family protection

PHASE 6: Orchestrator Refactoring
  â˜ Refactor calculationService.ts to use new modules
  â˜ Keep all method signatures identical
  â˜ Test backward compatibility

PHASE 7: Verification
  â˜ Run all existing tests (no changes needed)
  â˜ Verify no breaking changes
  â˜ Performance testing

PHASE 8: Cleanup
  â˜ Remove unused code from calculationService.ts
  â˜ Add orchestration pattern comments
  â˜ Update documentation
  â˜ Code review
  â˜ Merge to main

================================================================================
ğŸ¯ SUCCESS METRICS
================================================================================

1. âœ… Code Quality
   - Average file size < 200 lines
   - Cyclomatic complexity < 10 per function
   - Test coverage > 80%

2. âœ… Maintainability
   - Clear module boundaries
   - No circular dependencies
   - Well-documented interfaces

3. âœ… Performance
   - No performance regression
   - Same or better calculation speed

4. âœ… Compatibility
   - All existing code works without changes
   - No breaking changes to API

================================================================================
ğŸ“š RELATED FILES TO REVIEW
================================================================================

Current Implementation:
  - src/services/calculationService.ts (THIS FILE - TO BE REFACTORED)
  - app/utils/npvCalculations.ts
  - app/utils/deathBenefit.ts
  - app/utils/npvConfig.ts
  - src/utils/lcpMappingService.ts
  - src/types.ts

Files Using CalculationService:
  - src/hooks/useLCPFlow.ts
  - src/hooks/useGuaranteedFlow.ts
  - src/components/calculator/lcpstep/*.tsx
  - src/components/calculator/guaranteedstep/*.tsx

================================================================================
END OF REFACTORING ANALYSIS
================================================================================

